<!doctype html><html lang=en><head><title>NVIDIA Container Toolkit with Docker CDI :: Buffer Overflow</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I recently spent an hour (or three) troubleshooting hardware transcoding on my media server. At some point, an update to the NVIDIA Container Toolkit resulted in CUDA libraries not getting passed through correctly to my containerized Plex installation.
This error appeared in the Plex Media Server.log file every time I attempted to play a file that needed transcoding:
Dec 15, 2024 03:45:14.374 [140307690093368] ERROR - [Req#105/Transcode] [FFMPEG] - Cannot load libcuda.so.1 Dec 15, 2024 03:45:14.374 [140307690093368] ERROR - [Req#105/Transcode] [FFMPEG] - Could not dynamically load CUDA Running nvidia-smi inside the container also presented the following error:
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/notes/linux/docker/nvidia_ctk_docker_cdi/><link rel=stylesheet href=/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css><link rel=stylesheet href=/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css><link rel=stylesheet href=/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css><link rel=stylesheet href=/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css><link rel=stylesheet href=/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css><link rel=stylesheet href=/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css><link rel=stylesheet href=/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css><link rel=stylesheet href=/css/terminal.min.dd0bf9c7cacb24c1b0184f52f1869b274e06689557468cc7030ccf632328eb97.css><link rel=stylesheet href=/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=/favicon.png><link rel=apple-touch-icon href=/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="NVIDIA Container Toolkit with Docker CDI"><meta property="og:description" content="I recently spent an hour (or three) troubleshooting hardware transcoding on my media server. At some point, an update to the NVIDIA Container Toolkit resulted in CUDA libraries not getting passed through correctly to my containerized Plex installation.
This error appeared in the Plex Media Server.log file every time I attempted to play a file that needed transcoding:
Dec 15, 2024 03:45:14.374 [140307690093368] ERROR - [Req#105/Transcode] [FFMPEG] - Cannot load libcuda.so.1 Dec 15, 2024 03:45:14.374 [140307690093368] ERROR - [Req#105/Transcode] [FFMPEG] - Could not dynamically load CUDA Running nvidia-smi inside the container also presented the following error:
"><meta property="og:url" content="/notes/linux/docker/nvidia_ctk_docker_cdi/"><meta property="og:site_name" content="Buffer Overflow"><meta property="og:image" content="/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-12-14 00:00:00 +0000 UTC"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Buffer Overflow</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/about>About me</a></li><li><a href=/notes>Notes</a></li><li><a href=/posts>Blog</a></li><li><a href=https://github.com/danclough>Code</a></li><li><a href=https://infosec.exchange/@danclough>Mastodon</a></li><li><a href="https://bellard.org/jslinux/vm.html?cpu=riscv64&amp;url=buildroot-riscv64.cfg&amp;mem=256">Exit</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><ul class=menu><li class=menu__trigger>File&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/about>About me</a></li><li><a href=/notes>Notes</a></li><li><a href=/posts>Blog</a></li><li><a href=https://github.com/danclough>Code</a></li><li><a href=https://infosec.exchange/@danclough>Mastodon</a></li><li><a href="https://bellard.org/jslinux/vm.html?cpu=riscv64&amp;url=buildroot-riscv64.cfg&amp;mem=256">Exit</a></li></ul></li></ul></li></ul></nav></header><div class=breadcrumbs>/<a href=/notes/>notes</a>/<a href=/notes/linux/>linux</a>/<a href=/notes/linux/docker/>docker</a>/<div class=content><article class=post><h1 class=post-title><a href=/notes/linux/docker/nvidia_ctk_docker_cdi/>NVIDIA Container Toolkit with Docker CDI</a></h1><div class=post-meta><time class=post-date>2024-12-14</time></div><div class=post-content><div><p>I recently spent an hour (or three) troubleshooting hardware transcoding on my media server. At some point, an update to the NVIDIA Container Toolkit resulted in CUDA libraries not getting passed through correctly to my containerized Plex installation.</p><p>This error appeared in the <code>Plex Media Server.log</code> file every time I attempted to play a file that needed transcoding:</p><pre tabindex=0><code>Dec 15, 2024 03:45:14.374 [140307690093368] ERROR - [Req#105/Transcode] [FFMPEG] - Cannot load libcuda.so.1
Dec 15, 2024 03:45:14.374 [140307690093368] ERROR - [Req#105/Transcode] [FFMPEG] - Could not dynamically load CUDA
</code></pre><p>Running <code>nvidia-smi</code> inside the container also presented the following error:</p><pre tabindex=0><code>NVIDIA-SMI couldn&#39;t find libnvidia-ml.so library in your system. Please make sure that the NVIDIA Display Driver is properly installed and present in your system.
Please also try adding directory that contains libnvidia-ml.so to your system PATH.
</code></pre><p>Checking the library directory <code>/usr/lib/x86_64-linux-gnu/</code> in the container revealed the missing piece:</p><pre tabindex=0><code>libcuda.so -&gt; libcuda.so.1 (MISSING)
libcuda.so.535.183.01
libnvcuvid.so.535.183.01
libnvidia-allocator.so.535.183.01
libnvidia-cfg.so.535.183.01
libnvidia-eglcore.so.535.183.01
libnvidia-egl-gbm.so.1.1.0
libnvidia-egl-wayland.so.1.1.10
libnvidia-glcore.so.535.183.01
libnvidia-glsi.so.535.183.01
libnvidia-glvkspirv.so.535.183.01
libnvidia-ml.so.535.183.01
libnvidia-pkcs11-openssl3.so.535.183.01
libnvidia-ptxjitcompiler.so.535.183.01
libnvidia-rtcore.so.535.183.01
libnvidia-tls.so.535.183.01
</code></pre><p>Note the absence of default libraries - in this case, components like <code>libnvidia-ml.so.565.57.01</code> which should have a symlink called <code>libnvidia-ml.so</code> which makes it the default version. This also explains the error above for <code>libcuda.so.1</code>, which should have been reachable via <code>libcuda.so</code> if the link weren&rsquo;t missing.</p><p>I saw that the <code>nvidia-container-toolkit</code> had undergone quite a few updates since I first set it all up, so I tried updating the NVIDIA drivers on my system from <strong>535.183.01</strong> to <strong>565.57.01</strong> to see if installing newer drivers somehow forced the CTK to relink everything. That didn&rsquo;t help, and instead resulted in more libraries for the new version that still weren&rsquo;t linking to defaults.</p><p>I manually ran the <code>ldconfig</code> linker inside the container and observed that it correctly generated the symlinks. Plex could now see the CUDA library and <code>nvidia-smi</code> could report the GPU, but this was only a temporary fix and wouldn&rsquo;t survive a container rebuild.</p><p>Research led me to a <a href=https://github.com/NVIDIA/nvidia-container-toolkit/issues/128>GitHub issue on the <code>nvidia-container-toolkit</code> project</a> related to <a href=https://github.com/NVIDIA/nvidia-container-toolkit/blob/main/cmd/nvidia-ctk/README.md>CDI (container device interface) functionality</a>. CDI support seems to be a relatively new feature of the CTK which manages presenting the correct driver libraries through the container runtime. I didn&rsquo;t have any CDI configurations present on my system, so I followed the docs to generate one.</p><pre tabindex=0><code>nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
nvidia-ctk runtime configure --runtime=docker --cdi.enabled
systemctl restart docker
</code></pre><p>I also had to the add the device <code>nvidia.com/gpu=all</code> to the Plex service in my <code>docker-compose.yaml</code> file so the NVIDIA container runtime knows to use the CDI configuration.</p><pre tabindex=0><code>  plex:
    image: ghcr.io/linuxserver/plex
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    devices:
      - nvidia.com/gpu=all
</code></pre><p>Once I rebuilt the Plex container with the CDI configuration, all of the NVIDIA libraries in the container were correctly linked with default <code>.so.</code> versions and hardware transcoding worked as expected.</p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>